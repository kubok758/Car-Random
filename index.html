<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Ultimate Car Randomizer">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>CAR RANDOMIZER</title>
    <style>
        :root {
            --bg: #000000;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --eco: #34d399; --mid: #60a5fa; --pre: #a78bfa; --lux: #fbbf24; --mat: #f43f5e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            background: var(--bg); background-size: cover; background-position: center;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            color: var(--text);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            user-select: none; transition: background 0.5s ease;
        }
        body::before { content:''; position:absolute; inset:0; background: radial-gradient(circle at center, rgba(0,0,0,0.3), #000); z-index:0; pointer-events:none; }

        /* --- ANIMATIONS --- */
        @keyframes blurMove {
            0% { transform: scaleY(1); opacity: 1; filter: blur(0px); }
            50% { transform: scaleY(1.2); opacity: 0.7; filter: blur(4px); }
            100% { transform: scaleY(1); opacity: 1; filter: blur(0px); }
        }
        
        @keyframes impactFlash {
            0% { text-shadow: 0 0 50px currentColor; transform: scale(1.1); filter: brightness(2); }
            100% { text-shadow: 0 0 0 transparent; transform: scale(1); filter: brightness(1); }
        }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, -2px); }
        }

        .motion-blur { animation: blurMove 0.1s infinite; color: rgba(255,255,255,0.6); }
        .impact { animation: impactFlash 0.3s ease-out forwards; }
        .shaking { animation: screenShake 0.2s ease-out; }

        /* --- UI --- */
        .glass { background: var(--glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .icon-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .icon-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        .icon-btn.off { opacity: 0.4; } .slash { display: none; } .icon-btn.off .slash { display: block; }

        .top-bar { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        @supports (padding-top: env(safe-area-inset-top)) { .top-bar { top: calc(20px + env(safe-area-inset-top)); } }

        .wrapper { position: relative; z-index: 10; width: 90%; max-width: 420px; display: flex; flex-direction: column; gap: 20px; transition: 0.5s; }
        .wrapper.hidden { opacity: 0; transform: scale(0.9); pointer-events: none; }

        .app-title { text-align: center; font-size: 12px; letter-spacing: 4px; text-transform: uppercase; opacity: 0.5; font-weight: 700; margin-bottom: -10px; }

        .main-card { border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 220px; justify-content: center; }
        .res-tier { font-size: 12px; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 10px; opacity: 0.8; }
        .res-name { font-size: 26px; font-weight: 800; line-height: 1.1; margin-bottom: 5px; }
        .res-spec { font-size: 16px; font-weight: 500; opacity: 0.6; }
        .res-tune { font-size: 14px; color: var(--mat); margin-top: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .controls { display: grid; grid-template-columns: 1fr auto; gap: 12px; }
        .btn-spin { background: #fff; color: #000; border: none; border-radius: 18px; height: 64px; font-size: 18px; font-weight: 800; letter-spacing: 1px; cursor: pointer; box-shadow: 0 0 30px rgba(255,255,255,0.1); transition: 0.1s; }
        .btn-spin:active { transform: scale(0.98); background: #e5e5e5; }
        .btn-garage-main { width: 64px; height: 64px; border-radius: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-google { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 16px; height: 50px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; font-weight: 600; cursor: pointer; opacity: 0; pointer-events: none; transition: 0.3s; }
        .btn-google.visible { opacity: 1; pointer-events: auto; }

        /* --- CINEMATIC OVERLAY --- */
        #cinematic {
            position: fixed; inset: 0; background: #000; z-index: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #cinematic.active { opacity: 1; pointer-events: auto; }

        .cine-container { width: 100%; max-width: 400px; padding: 20px; display: flex; flex-direction: column; gap: 15px; text-align: center; }
        
        .cine-row {
            opacity: 0.2; transform: translateY(10px); transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; min-height: 50px;
        }
        .cine-row.spinning { opacity: 0.8; transform: scale(1.05); }
        .cine-row.done { opacity: 1; transform: scale(1); }
        
        .cine-label { font-size: 10px; text-transform: uppercase; letter-spacing: 3px; color: #555; margin-bottom: 4px; font-weight: 700; }
        .cine-val { font-size: 24px; font-weight: 800; text-transform: uppercase; line-height: 1; white-space: nowrap; }
        
        #cTierVal { font-size: 20px; letter-spacing: 2px; }
        #cBrandVal { font-size: 32px; }
        #cModelVal { font-size: 26px; }
        #cSpecVal { font-size: 18px; color: #aaa; }
        #cTuneVal { font-size: 16px; color: #666; }
        #cTuneVal.tuned { color: var(--mat); text-shadow: 0 0 15px var(--mat); }

        #claimBtn {
            margin-top: 40px; background: #fff; color: #000; border: none;
            padding: 20px 0; width: 100%; font-size: 16px; font-weight: 900; letter-spacing: 2px;
            border-radius: 16px; cursor: pointer; opacity: 0; transform: translateY(20px); transition: 0.5s;
        }
        #claimBtn.show { opacity: 1; transform: translateY(0); box-shadow: 0 0 50px rgba(255,255,255,0.4); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; flex-direction: column; justify-content: flex-end; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #111; border-top: 1px solid #333; border-radius: 24px 24px 0 0; padding: 20px; height: 80vh; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .g-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .g-item { background: #1a1a1a; border: 1px solid #333; border-radius: 14px; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #444; }
        
        /* Tier Colors */
        .c-eco { color: var(--eco); } .b-eco { border-color: var(--eco); }
        .c-mid { color: var(--mid); } .b-mid { border-color: var(--mid); }
        .c-pre { color: var(--pre); } .b-pre { border-color: var(--pre); }
        .c-lux { color: var(--lux); } .b-lux { border-color: var(--lux); }
        .c-mat { color: var(--mat); } .b-mat { border-color: var(--mat); }

        /* CHEAT & BG menus omitted for brevity but logic retained */
        .bg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .bg-item { aspect-ratio: 1; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; }
        #cheatMenu { position: absolute; top: 100px; left: 50%; transform: translate(-50%, -20px); background: #111; border: 1px solid #444; padding: 10px; border-radius: 16px; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 2000; }
        #cheatMenu.active { opacity: 1; transform: translate(-50%, 0); pointer-events: auto; }
        .cheat-btn { padding: 10px; background: #222; margin: 2px; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="icon-btn glass" onclick="openModal('bgModal')"><svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
    <div class="icon-btn glass" id="vibBtn" onclick="toggleVibro()"><svg viewBox="0 0 24 24"><rect x="10" y="4" width="4" height="16" rx="2"/><line class="slash" x1="3" y1="3" x2="21" y2="21"/></svg></div>
    <div class="icon-btn glass" id="sndBtn" onclick="toggleSound()"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line class="slash" x1="23" y1="9" x2="17" y2="15"/></svg></div>
</div>

<div class="wrapper" id="mainWrapper">
    <div class="app-title">Car Randomizer</div>
    <div class="main-card glass" id="resCard">
        <div class="res-tier" id="mTier">ГОТОВ К ЗАЕЗДУ</div>
        <div class="res-name" id="mName">НАЖМИ START</div>
        <div class="res-spec" id="mSpec">ИСПЫТАЙ УДАЧУ</div>
        <div class="res-tune" id="mTune"></div>
    </div>
    <div class="controls">
        <button class="btn-spin" onclick="startCinematic()">КРУТИТЬ</button>
        <div class="btn-garage-main glass" onclick="renderGarage();openModal('garageModal')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </div>
    </div>
    <div class="btn-google" id="gBtn" onclick="googleSearch()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        ПОСМОТРЕТЬ ФОТО
    </div>
</div>

<div id="cinematic">
    <div class="cine-container">
        <div class="cine-row" id="r1"><div class="cine-label">КЛАСС</div><div class="cine-val" id="v1"></div></div>
        <div class="cine-row" id="r2"><div class="cine-label">МАРКА</div><div class="cine-val" id="v2"></div></div>
        <div class="cine-row" id="r3"><div class="cine-label">МОДЕЛЬ</div><div class="cine-val" id="v3"></div></div>
        <div class="cine-row" id="r4"><div class="cine-label">СПЕК</div><div class="cine-val" id="v4"></div></div>
        <div class="cine-row" id="r5"><div class="cine-label">ТЮНИНГ</div><div class="cine-val" id="v5"></div></div>
        <button id="claimBtn" onclick="claim()">ЗАБРАТЬ</button>
    </div>
</div>

<div class="modal" id="garageModal"><div class="modal-content"><div class="modal-header"><h3>ГАРАЖ</h3><div onclick="closeModal('garageModal')">✕</div></div><div class="g-list" id="garageList"></div><button onclick="clearGarage()" style="margin-top:10px;padding:15px;background:#333;color:#fff;border:none;border-radius:12px">ОЧИСТИТЬ</button></div></div>
<div class="modal" id="bgModal"><div class="modal-content" style="height:auto"><div class="modal-header"><h3>ФОН</h3><div onclick="closeModal('bgModal')">✕</div></div><div class="bg-grid"><div class="bg-item" style="background:#000" onclick="sBg('c','#000')"></div><div class="bg-item" style="background:#1a1a1a" onclick="sBg('c','#1a1a1a')"></div><div class="bg-item" style="background:url('mercedes.jpg') center/cover" onclick="sBg('i','mercedes.jpg')"></div></div></div></div>
<div id="cheatMenu"><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><button class="cheat-btn" onclick="sc('economy')">ECO</button><button class="cheat-btn" onclick="sc('middle')">MID</button><button class="cheat-btn" onclick="sc('premium')">PRE</button><button class="cheat-btn" onclick="sc('luxury')">LUX</button><button class="cheat-btn" onclick="sc('matmall')">MAT</button></div></div>

<script>
    let snd=true, vib=true, cheat=null, audioCtx=null, gData=null;
    let garage = JSON.parse(localStorage.getItem('garage_v20')||'[]');

    window.onload = () => {
        if(localStorage.getItem('snd')==='0') toggleSound();
        if(localStorage.getItem('vib')==='0') toggleVibro();
        const bgt=localStorage.getItem('bgt'), bgv=localStorage.getItem('bgv');
        if(bgt&&bgv) appBg(bgt,bgv);
        
        document.querySelector('.app-title').addEventListener('click', (e) => {
            if(e.detail===3 && prompt("CODE")==="758") document.getElementById('cheatMenu').classList.add('active');
        });
    };

    function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); }
    function click() { if(snd&&audioCtx){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=800; g.gain.setValueAtTime(0.05,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.05); o.start();o.stop(audioCtx.currentTime+0.05); } }
    function boom() { if(snd&&audioCtx){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.type='triangle'; o.frequency.value=80; g.gain.setValueAtTime(0.4,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3); o.start();o.stop(audioCtx.currentTime+0.3); } }
    function shock() { if(vib&&navigator.vibrate) navigator.vibrate([30,30,30]); }

    function toggleSound(){ snd=!snd; document.getElementById('sndBtn').classList.toggle('off',!snd); localStorage.setItem('snd',snd?'1':'0'); if(snd)initAudio(); }
    function toggleVibro(){ vib=!vib; document.getElementById('vibBtn').classList.toggle('off',!vib); localStorage.setItem('vib',vib?'1':'0'); }
    function openModal(id){ document.getElementById(id).classList.add('active'); }
    function closeModal(id){ document.getElementById(id).classList.remove('active'); }
    function sBg(t,v){ appBg(t,v); localStorage.setItem('bgt',t); localStorage.setItem('bgv',v); closeModal('bgModal'); }
    function appBg(t,v){ document.body.style.background = t==='c'?v:`url('${v}') center/cover`; }
    function sc(v){ cheat=v; document.getElementById('cheatMenu').classList.remove('active'); }

    const r=(a)=>a[Math.floor(Math.random()*a.length)];
    const ch=(p)=>Math.random()<p;
    
    // --- REALISTIC SPIN POOLS ---
    function getSpinPool(type) {
        if(type==='brand') return ['BMW','MERCEDES','TOYOTA','AUDI','PORSCHE','LADA','HAVAL','KIA','HONDA','TANK','ZEEKR','FERRARI','FORD'];
        if(type==='model') return ['CAMRY','M5','911','PRIORA','CIVIC','CLS','URUS','VESTA','E63','LAND CRUISER','MONJARO','MUSTANG','GOLF'];
        if(type==='spec') return ['COMPETITION','TURBO S','3.5 V6','AMG S','LONG','PERFORMANCE','GT-LINE','PLATINUM','SPORT','BLACK BADGE'];
        if(type==='tune') return ['BRABUS','STAGE 2','MANHART','STOCK','HKS','LIBERTY WALK','ALPINA','STOCK','STOCK','ABT'];
        return ['...'];
    }

    function getTune(t){ 
        if(!ch(0.2))return null;
        const map={'b':['Manhart','G-Power','Alpina'],'m':['Brabus','Mansory'],'j':['HKS','VeilSide'],'l':['Stinger','Turbo'],'c':['Chip','Sport']};
        return r(map[t]||['Stage 2']);
    }

    function generate() {
        let t = cheat || (()=>{const x=Math.random();return x<0.01?'matmall':x<0.26?'economy':x<0.51?'middle':x<0.76?'premium':'luxury'})();
        cheat=null;
        let d={tier:t, tune:null};
        
        if(t=='economy'){
            d.tn='ЭКОНОМ'; d.css='c-eco'; d.gcss='eco';
            const c=[{b:'Lada',m:'Vesta NG',s:'Sport',t:'l'},{b:'VW',m:'Polo',s:'1.4 TSI',t:'c'},{b:'Skoda',m:'Rapid',s:'Monte Carlo',t:'c'},{b:'Kia',m:'Rio',s:'X-Line',t:'c'}];
            const x=r(c); d.b=x.b; d.m=x.m; d.s=x.s; d.tune=getTune(x.t);
        } else if(t=='middle'){
            d.tn='СРЕДНИЙ'; d.css='c-mid'; d.gcss='mid';
            const c=[{b:'Toyota',m:'Mark II',s:'Tourer V',t:'j'},{b:'Toyota',m:'Camry',s:'3.5 V6',t:'j'},{b:'Subaru',m:'WRX STI',s:'GC8',t:'j'},{b:'Geely',m:'Monjaro',s:'Flagship',t:'c'}];
            const x=r(c); d.b=x.b; d.m=x.m; d.s=x.s; d.tune=getTune(x.t);
        } else if(t=='premium'){
            d.tn='ПРЕМИУМ'; d.css='c-pre'; d.gcss='pre';
            const c=[{b:'BMW',m:'M5 F90',s:'Competition',t:'b'},{b:'Mercedes',m:'E63 S',s:'W213',t:'m'},{b:'Audi',m:'RS6',s:'C8 Avant',t:'c'},{b:'Zeekr',m:'001',s:'FR',t:'c'}];
            const x=r(c); d.b=x.b; d.m=x.m; d.s=x.s; d.tune=getTune(x.t);
        } else if(t=='luxury'){
            d.tn='ЛЮКС'; d.css='c-lux'; d.gcss='lux';
            const c=[{b:'Ferrari',m:'SF90',s:'Stradale'},{b:'Lamborghini',m:'Urus',s:'Performante'},{b:'Porsche',m:'911 Turbo S',s:'(992)'},{b:'Bugatti',m:'Chiron',s:'Super Sport'}];
            const x=r(c); d.b=x.b; d.m=x.m; d.s=x.s; d.tune=getTune('m');
        } else {
            d.tn='MAT-MALL'; d.css='c-mat'; d.gcss='mat';
            d.b='Porsche'; d.m='Cayenne'; d.s='Turbo GT'; d.tune='Mat-Mall Edition';
        }
        return d;
    }

    async function spinRow(id, final, poolType, css) {
        const el = document.getElementById(id);
        const val = el.querySelector('.cine-val');
        el.classList.add('active');
        val.className = 'cine-val motion-blur'; // Start blur
        
        const pool = getSpinPool(poolType);
        
        // Spin fast
        for(let i=0; i<15; i++) {
            val.innerText = r(pool);
            click();
            await new Promise(r=>setTimeout(r, 60)); // Fast ticks
        }
        
        // Stop
        val.innerText = final;
        val.className = 'cine-val impact'; // Flash
        if(css) val.classList.add(css);
        
        document.body.classList.add('shaking'); // Screen shake
        setTimeout(()=>document.body.classList.remove('shaking'), 200);
        boom(); 
    }

    async function startCinematic() {
        initAudio();
        gData = generate();
        
        document.getElementById('mainWrapper').classList.add('hidden');
        document.getElementById('cinematic').classList.add('active');
        document.getElementById('claimBtn').classList.remove('show');
        
        ['v1','v2','v3','v4','v5'].forEach(id=>document.getElementById(id).innerText='');
        ['r1','r2','r3','r4','r5'].forEach(id=>document.getElementById(id).classList.remove('active'));

        // Sequence
        await new Promise(r=>setTimeout(r, 500));
        await spinRow('r1', gData.tn, 'tier', gData.css);
        
        await new Promise(r=>setTimeout(r, 400));
        await spinRow('r2', gData.b, 'brand');
        
        await new Promise(r=>setTimeout(r, 400));
        await spinRow('r3', gData.m, 'model');
        
        await new Promise(r=>setTimeout(r, 400));
        await spinRow('r4', gData.s, 'spec');
        
        await new Promise(r=>setTimeout(r, 400));
        // Tuning logic for display
        const tTxt = gData.tune ? gData.tune : "STOCK";
        const tCss = gData.tune ? 'c-mat' : null;
        await spinRow('r5', tTxt, 'tune', tCss);
        if(!gData.tune) document.getElementById('v5').style.opacity = 0.5;

        shock();
        await new Promise(r=>setTimeout(r, 300));
        document.getElementById('claimBtn').classList.add('show');
    }

    function claim() {
        document.getElementById('cinematic').classList.remove('active');
        document.getElementById('mainWrapper').classList.remove('hidden');
        
        document.getElementById('mTier').innerText = gData.tn;
        document.getElementById('mTier').className = 'res-tier '+gData.css;
        document.getElementById('mName').innerText = gData.b + ' ' + gData.m;
        document.getElementById('mSpec').innerText = gData.s;
        document.getElementById('mTune').innerText = gData.tune ? '+ '+gData.tune : '';
        document.getElementById('gBtn').classList.add('visible');

        const n = `${gData.b} ${gData.m} ${gData.s}`;
        const ex = garage.find(c => c.n === n && c.t === gData.tune);
        if(ex) ex.c++;
        else garage.unshift({n:n, tn:gData.tn, t:gData.tune, css:gData.gcss, c:1});
        localStorage.setItem('garage_v20', JSON.stringify(garage));
    }

    function renderGarage() {
        const l = document.getElementById('garageList');
        l.innerHTML = garage.length ? '' : '<div style="color:#666;text-align:center;padding:20px">Пусто</div>';
        garage.forEach(i => {
            const t = i.t ? `<span style="color:var(--mat)"> ${i.t}</span>` : '';
            l.innerHTML += `<div class="g-item b-${i.css}"><div><div style="font-size:10px;opacity:0.7">${i.tn}</div><div class="g-name">${i.n}${t}</div></div><div class="g-count">x${i.c}</div></div>`;
        });
    }

    function clearGarage() { garage=[]; localStorage.removeItem('garage_v20'); renderGarage(); }
    function googleSearch() { if(gData) window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(gData.b+' '+gData.m)}`, '_blank'); }
</script>
</body>
</html>
